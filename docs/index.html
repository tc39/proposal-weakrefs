<!doctype html>
<head><meta charset="utf-8">
<script src="ecmarkup.js" defer=""></script>
<link rel="stylesheet" href="ecmarkup.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_light.min.css">

<script type="application/json" id="menu-search-biblio">[{"type":"clause","id":"sec-weak-ref-target","aoid":null,"title":" WeakRef ( target )  ","titleHTML":" WeakRef ( <var>target</var> )  ","number":"1.1.1","namespace":"<no location>","location":"","referencingIds":[],"key":" WeakRef ( target )  "},{"type":"clause","id":"sec-weak-ref-constructor","aoid":null,"title":"The WeakRef Constructor","titleHTML":"The WeakRef Constructor","number":"1.1","namespace":"<no location>","location":"","referencingIds":[],"key":"The WeakRef Constructor"},{"type":"clause","id":"sec-weak-ref.prototype","aoid":null,"title":"WeakRef.prototype","titleHTML":"WeakRef.prototype","number":"1.2.1","namespace":"<no location>","location":"","referencingIds":[],"key":"WeakRef.prototype"},{"type":"clause","id":"sec-get-weak-ref-@@species","aoid":null,"title":"get WeakRef [ @@species ]","titleHTML":"get WeakRef [ @@species ]","number":"1.2.2","namespace":"<no location>","location":"","referencingIds":[],"key":"get WeakRef [ @@species ]"},{"type":"clause","id":"sec-properties-of-the-weak-ref-constructor","aoid":null,"title":"Properties of the WeakRef Constructor","titleHTML":"Properties of the WeakRef Constructor","number":"1.2","namespace":"<no location>","location":"","referencingIds":[],"key":"Properties of the WeakRef Constructor"},{"type":"term","term":"%WeakRefPrototype%","refId":"sec-properties-of-the-weak-ref-prototype-object","referencingIds":[],"namespace":"<no location>","location":"","key":"%WeakRefPrototype%"},{"type":"clause","id":"sec-weak-ref.prototype.deref","aoid":null,"title":"WeakRef.prototype.deref ( )","titleHTML":"WeakRef.prototype.deref ( )","number":"1.3.1","namespace":"<no location>","location":"","referencingIds":[],"key":"WeakRef.prototype.deref ( )"},{"type":"clause","id":"sec-properties-of-the-weak-ref-prototype-object","aoid":null,"title":"Properties of the WeakRef Prototype Object","titleHTML":"Properties of the WeakRef Prototype Object","number":"1.3","namespace":"<no location>","location":"","referencingIds":["_ref_3"],"key":"Properties of the WeakRef Prototype Object"},{"type":"clause","id":"sec-properties-of-weak-ref-instances","aoid":null,"title":"Properties of WeakRef Instances","titleHTML":"Properties of WeakRef Instances","number":"1.4","namespace":"<no location>","location":"","referencingIds":[],"key":"Properties of WeakRef Instances"},{"type":"clause","id":"sec-weak-ref-objects","aoid":null,"title":" WeakRef Objects  ","titleHTML":" WeakRef Objects  ","number":"1","namespace":"<no location>","location":"","referencingIds":[],"key":" WeakRef Objects  "},{"type":"term","term":"%FinalizationGroup%","refId":"sec-finalization-group-constructor","referencingIds":[],"namespace":"<no location>","location":"","key":"%FinalizationGroup%"},{"type":"clause","id":"sec-finalization-group-cleanup-callback","aoid":null,"title":" FinalizationGroup ( cleanupCallback )  ","titleHTML":" FinalizationGroup ( <var>cleanupCallback</var> )  ","number":"2.1.1","namespace":"<no location>","location":"","referencingIds":[],"key":" FinalizationGroup ( cleanupCallback )  "},{"type":"clause","id":"sec-finalization-group-constructor","aoid":null,"title":"The FinalizationGroup Constructor","titleHTML":"The FinalizationGroup Constructor","number":"2.1","namespace":"<no location>","location":"","referencingIds":["_ref_10"],"key":"The FinalizationGroup Constructor"},{"type":"clause","id":"sec-finalization-group.prototype","aoid":null,"title":"FinalizationGroup.prototype","titleHTML":"FinalizationGroup.prototype","number":"2.2.1","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup.prototype"},{"type":"clause","id":"sec-get-finalization-group-@@species","aoid":null,"title":"get FinalizationGroup [ @@species ]","titleHTML":"get FinalizationGroup [ @@species ]","number":"2.2.2","namespace":"<no location>","location":"","referencingIds":[],"key":"get FinalizationGroup [ @@species ]"},{"type":"clause","id":"sec-properties-of-the-finalization-group-constructor","aoid":null,"title":"Properties of the FinalizationGroup Constructor","titleHTML":"Properties of the FinalizationGroup Constructor","number":"2.2","namespace":"<no location>","location":"","referencingIds":[],"key":"Properties of the FinalizationGroup Constructor"},{"type":"term","term":"%FinalizationGroupPrototype%","refId":"sec-properties-of-the-finalization-group-prototype-object","referencingIds":[],"namespace":"<no location>","location":"","key":"%FinalizationGroupPrototype%"},{"type":"clause","id":"sec-finalization-group.prototype.constructor","aoid":null,"title":"FinalizationGroup.prototype.constructor","titleHTML":"FinalizationGroup.prototype.constructor","number":"2.3.1","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup.prototype.constructor"},{"type":"clause","id":"sec-finalization-group.prototype.register","aoid":null,"title":"FinalizationGroup.prototype.register ( target , holdings [, unregisterToken ]  )","titleHTML":"FinalizationGroup.prototype.register ( <var>target</var> , <var>holdings</var> [, <var>unregisterToken</var> ]  )","number":"2.3.2","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup.prototype.register ( target , holdings [, unregisterToken ]  )"},{"type":"clause","id":"sec-finalization-group.prototype.unregister","aoid":null,"title":"FinalizationGroup.prototype.unregister ( unregisterToken )","titleHTML":"FinalizationGroup.prototype.unregister ( <var>unregisterToken</var> )","number":"2.3.3","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup.prototype.unregister ( unregisterToken )"},{"type":"clause","id":"sec-finalization-group.prototype.cleanupSome","aoid":null,"title":"FinalizationGroup.prototype.cleanupSome ( [ callback ] )","titleHTML":"FinalizationGroup.prototype.cleanupSome ( [ <var>callback</var> ] )","number":"2.3.4","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup.prototype.cleanupSome ( [ callback ] )"},{"type":"clause","id":"sec-properties-of-the-finalization-group-prototype-object","aoid":null,"title":"Properties of the FinalizationGroup Prototype Object","titleHTML":"Properties of the FinalizationGroup Prototype Object","number":"2.3","namespace":"<no location>","location":"","referencingIds":["_ref_9"],"key":"Properties of the FinalizationGroup Prototype Object"},{"type":"clause","id":"sec-properties-of-finalization-group-instances","aoid":null,"title":"Properties of FinalizationGroup Instances","titleHTML":"Properties of FinalizationGroup Instances","number":"2.4","namespace":"<no location>","location":"","referencingIds":[],"key":"Properties of FinalizationGroup Instances"},{"type":"op","aoid":"CreateFinalizationGroupCleanupIterator","refId":"sec-createfinalizationgroupcleanupiterator","location":"","referencingIds":[],"key":"CreateFinalizationGroupCleanupIterator"},{"type":"clause","id":"sec-createfinalizationgroupcleanupiterator","aoid":"CreateFinalizationGroupCleanupIterator","title":"CreateFinalizationGroupCleanupIterator ( finalizationGroup )","titleHTML":"CreateFinalizationGroupCleanupIterator ( <var>finalizationGroup</var> )","number":"2.5.1","namespace":"<no location>","location":"","referencingIds":["_ref_31"],"key":"CreateFinalizationGroupCleanupIterator ( finalizationGroup )"},{"type":"term","term":"%FinalizationGroupCleanupIteratorPrototyp%","refId":"sec-%finalizationgroupcleanupiterator%-object","referencingIds":[],"namespace":"<no location>","location":"","key":"%FinalizationGroupCleanupIteratorPrototyp%"},{"type":"clause","id":"sec-%finalizationgroupcleanupiterator%.next","aoid":null,"title":"%FinalizationGroupCleanupIteratorPrototype%.next ( )","titleHTML":"%FinalizationGroupCleanupIteratorPrototype%.next ( )","number":"2.5.2.1","namespace":"<no location>","location":"","referencingIds":[],"key":"%FinalizationGroupCleanupIteratorPrototype%.next ( )"},{"type":"clause","id":"sec-%finalizationgroupcleanupiteratorprototype%-@@tostringtag","aoid":null,"title":"%FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]","titleHTML":"%FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]","number":"2.5.2.2","namespace":"<no location>","location":"","referencingIds":[],"key":"%FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]"},{"type":"clause","id":"sec-%finalizationgroupcleanupiterator%-object","aoid":null,"title":"The %FinalizationGroupCleanupIteratorPrototype% Object","titleHTML":"The %FinalizationGroupCleanupIteratorPrototype% Object","number":"2.5.2","namespace":"<no location>","location":"","referencingIds":[],"key":"The %FinalizationGroupCleanupIteratorPrototype% Object"},{"type":"clause","id":"sec-properties-of-finalization-group-cleanup-iterator-instances","aoid":null,"title":"Properties of FinalizationGroup Cleanup Iterator Instances","titleHTML":"Properties of FinalizationGroup Cleanup Iterator Instances","number":"2.5.3","namespace":"<no location>","location":"","referencingIds":[],"key":"Properties of FinalizationGroup Cleanup Iterator Instances"},{"type":"clause","id":"sec-finalization-group-cleanup-iterator-objects","aoid":null,"title":"FinalizationGroup Cleanup Iterator Objects","titleHTML":"FinalizationGroup Cleanup Iterator Objects","number":"2.5","namespace":"<no location>","location":"","referencingIds":[],"key":"FinalizationGroup Cleanup Iterator Objects"},{"type":"clause","id":"sec-finalization-group-objects","aoid":null,"title":" FinalizationGroup Objects  ","titleHTML":" FinalizationGroup Objects  ","number":"2","namespace":"<no location>","location":"","referencingIds":[],"key":" FinalizationGroup Objects  "},{"type":"table","id":"table-agent-record","number":1,"caption":"Table 1: Agent Record Fields","referencingIds":[],"namespace":"<no location>","location":"","key":"Table 1: Agent Record Fields"},{"type":"op","aoid":"DoAgentFinalization","refId":"sec-do-agent-finalization","location":"","referencingIds":[],"key":"DoAgentFinalization"},{"type":"clause","id":"sec-do-agent-finalization","aoid":"DoAgentFinalization","title":" DoAgentFinalization ( )","titleHTML":" DoAgentFinalization ( )","number":"3.1","namespace":"<no location>","location":"","referencingIds":[],"key":" DoAgentFinalization ( )"},{"type":"op","aoid":"CheckForEmptyCells","refId":"sec-check-for-empty-cells","location":"","referencingIds":[],"key":"CheckForEmptyCells"},{"type":"clause","id":"sec-check-for-empty-cells","aoid":"CheckForEmptyCells","title":" CheckForEmptyCells ( finalizationGroup )  ","titleHTML":" CheckForEmptyCells ( <var>finalizationGroup</var> )  ","number":"3.2","namespace":"<no location>","location":"","referencingIds":["_ref_27"],"key":" CheckForEmptyCells ( finalizationGroup )  "},{"type":"op","aoid":"FinalizationGroupCleanupJob","refId":"sec-finalization-group-cleanup-job","location":"","referencingIds":[],"key":"FinalizationGroupCleanupJob"},{"type":"clause","id":"sec-finalization-group-cleanup-job","aoid":"FinalizationGroupCleanupJob","title":" FinalizationGroupCleanupJob ( finalizationGroup [ , callback ] )  ","titleHTML":" FinalizationGroupCleanupJob ( <var>finalizationGroup</var> [ , <var>callback</var> ] )  ","number":"3.3","namespace":"<no location>","location":"","referencingIds":["_ref_16","_ref_29"],"key":" FinalizationGroupCleanupJob ( finalizationGroup [ , callback ] )  "},{"type":"op","aoid":"KeepDuringJob","refId":"sec-keepduringjob","location":"","referencingIds":[],"key":"KeepDuringJob"},{"type":"clause","id":"sec-keepduringjob","aoid":"KeepDuringJob","title":"KeepDuringJob ( object )","titleHTML":"KeepDuringJob ( <var>object</var> )","number":"3.4","namespace":"<no location>","location":"","referencingIds":["_ref_2","_ref_5","_ref_6","_ref_25"],"key":"KeepDuringJob ( object )"},{"type":"clause","id":"sec-abstract-jobs","aoid":null,"title":" Abstract Jobs  ","titleHTML":" Abstract Jobs  ","number":"3","namespace":"<no location>","location":"","referencingIds":[],"key":" Abstract Jobs  "}]</script><script>"use strict";

function Search(menu) {
  this.menu = menu;
  this.$search = document.getElementById('menu-search');
  this.$searchBox = document.getElementById('menu-search-box');
  this.$searchResults = document.getElementById('menu-search-results');
  
  this.loadBiblio();
  
  document.addEventListener('keydown', this.documentKeydown.bind(this));
  
  this.$searchBox.addEventListener('keydown', debounce(this.searchBoxKeydown.bind(this), { stopPropagation: true }));
  this.$searchBox.addEventListener('keyup', debounce(this.searchBoxKeyup.bind(this), { stopPropagation: true }));
}

Search.prototype.loadBiblio = function () {
  var $biblio = document.getElementById('menu-search-biblio');
  if (!$biblio) {
    this.biblio = [];
  } else {
    this.biblio = JSON.parse($biblio.textContent);
    this.biblio.clauses = this.biblio.filter(function (e) { return e.type === 'clause' });
    this.biblio.byId = this.biblio.reduce(function (map, entry) {
      map[entry.id] = entry;
      return map;
    }, {});
  }
}

Search.prototype.documentKeydown = function (e) {
  if (e.keyCode === 191) {
    e.preventDefault();
    e.stopPropagation();
    this.triggerSearch();
  }
}

Search.prototype.searchBoxKeydown = function (e) {
  e.stopPropagation();
  e.preventDefault();
  if (e.keyCode === 191 && e.target.value.length === 0) {
    e.preventDefault();
  } else if (e.keyCode === 13) {
    e.preventDefault();
    this.selectResult();
  }
}

Search.prototype.searchBoxKeyup = function (e) {
  if (e.keyCode === 13 || e.keyCode === 9) {
    return;
  }
  
  this.search(e.target.value);
}


Search.prototype.triggerSearch = function (e) {
  if (this.menu.isVisible()) {
    this._closeAfterSearch = false;
  } else {
    this._closeAfterSearch = true;
    this.menu.show();
  }

  this.$searchBox.focus();
  this.$searchBox.select();
}
// bit 12 - Set if the result starts with searchString
// bits 8-11: 8 - number of chunks multiplied by 2 if cases match, otherwise 1.
// bits 1-7: 127 - length of the entry
// General scheme: prefer case sensitive matches with fewer chunks, and otherwise
// prefer shorter matches.
function relevance(result, searchString) {
  var relevance = 0;
  
  relevance = Math.max(0, 8 - result.match.chunks) << 7;
  
  if (result.match.caseMatch) {
    relevance *= 2;
  }
  
  if (result.match.prefix) {
    relevance += 2048
  }
  
  relevance += Math.max(0, 255 - result.entry.key.length);
  
  return relevance;
}

Search.prototype.search = function (searchString) {
  var s = Date.now();

  if (searchString === '') {
    this.displayResults([]);
    this.hideSearch();
    return;
  } else {
    this.showSearch();
  }
  
  if (searchString.length === 1) {
    this.displayResults([]);
    return;
  }
    
  var results;

  if (/^[\d\.]*$/.test(searchString)) {
    results = this.biblio.clauses.filter(function (clause) {
      return clause.number.substring(0, searchString.length) === searchString;
    }).map(function (clause) {
      return { entry: clause };
    });
  } else {
    results = [];
    
    for (var i = 0; i < this.biblio.length; i++) {
      var entry = this.biblio[i];
      if (!entry.key) {
        // biblio entries without a key aren't searchable
        continue;
      }

      var match = fuzzysearch(searchString, entry.key);
      if (match) {
        results.push({ entry: entry, match: match });
      }
    }
  
    results.forEach(function (result) {
      result.relevance = relevance(result, searchString);
    });
    
    results = results.sort(function (a, b) { return b.relevance - a.relevance });

  }

  if (results.length > 50) {
    results = results.slice(0, 50);
  }
  
  this.displayResults(results);
}
Search.prototype.hideSearch = function () {
  this.$search.classList.remove('active');
}

Search.prototype.showSearch = function () {
  this.$search.classList.add('active');
}

Search.prototype.selectResult = function () {
  var $first = this.$searchResults.querySelector('li:first-child a');

  if ($first) {
    document.location = $first.getAttribute('href');
  }
  
  this.$searchBox.value = '';
  this.$searchBox.blur();
  this.displayResults([]);
  this.hideSearch();

  if (this._closeAfterSearch) {
    this.menu.hide();
  }
}

Search.prototype.displayResults = function (results) {
  if (results.length > 0) {
    this.$searchResults.classList.remove('no-results');
    
    var html = '<ul>';

    results.forEach(function (result) {
      var entry = result.entry;
      var id = entry.id;
      var cssClass = '';
      var text = '';

      if (entry.type === 'clause') {
        var number = entry.number ? entry.number + ' ' : '';
        text = number + entry.key;
        cssClass = 'clause';
        id = entry.id;
      } else if (entry.type === 'production') {
        text = entry.key;
        cssClass = 'prod';
        id = entry.id;  
      } else if (entry.type === 'op') {
        text = entry.key;
        cssClass = 'op';
        id = entry.id || entry.refId;
      } else if (entry.type === 'term') {
        text = entry.key;
        cssClass = 'term';
        id = entry.id || entry.refId;
      }

      if (text) {
        html += '<li class=menu-search-result-' + cssClass + '><a href="#' + id + '">' + text + '</a></li>'
      }
    });

    html += '</ul>'

    this.$searchResults.innerHTML = html;
  } else {
    this.$searchResults.innerHTML = '';
    this.$searchResults.classList.add('no-results');
  }
}


function Menu() {
  this.$toggle = document.getElementById('menu-toggle');
  this.$menu = document.getElementById('menu');
  this.$toc = document.querySelector('menu-toc > ol');
  this.$pins = document.querySelector('#menu-pins');
  this.$pinList = document.getElementById('menu-pins-list');
  this.$toc = document.querySelector('#menu-toc > ol');
  this.$specContainer = document.getElementById('spec-container');
  this.search = new Search(this);
  
  this._pinnedIds = {}; 
  this.loadPinEntries();

  // toggle menu
  this.$toggle.addEventListener('click', this.toggle.bind(this));

  // keydown events for pinned clauses
  document.addEventListener('keydown', this.documentKeydown.bind(this));

  // toc expansion
  var tocItems = this.$menu.querySelectorAll('#menu-toc li');
  for (var i = 0; i < tocItems.length; i++) {
    var $item = tocItems[i];
    $item.addEventListener('click', function($item, event) {
      $item.classList.toggle('active');
      event.stopPropagation();
    }.bind(null, $item));
  }

  // close toc on toc item selection
  var tocLinks = this.$menu.querySelectorAll('#menu-toc li > a');
  for (var i = 0; i < tocLinks.length; i++) {
    var $link = tocLinks[i];
    $link.addEventListener('click', function(event) {
      this.toggle();
      event.stopPropagation();
    }.bind(this));
  }

  // update active clause on scroll
  window.addEventListener('scroll', debounce(this.updateActiveClause.bind(this)));
  this.updateActiveClause();

  // prevent menu scrolling from scrolling the body
  this.$toc.addEventListener('wheel', function (e) {
    var target = e.currentTarget;
    var offTop = e.deltaY < 0 && target.scrollTop === 0;
    if (offTop) {
      e.preventDefault();
    }
    var offBottom = e.deltaY > 0
                    && target.offsetHeight + target.scrollTop >= target.scrollHeight;

    if (offBottom) {
		  e.preventDefault();
	  }
  })
}

Menu.prototype.documentKeydown = function (e) {
  e.stopPropagation();
  if (e.keyCode === 80) {
    this.togglePinEntry();
  } else if (e.keyCode > 48 && e.keyCode < 58) {
    this.selectPin(e.keyCode - 49);
  }
}

Menu.prototype.updateActiveClause = function () {
  this.setActiveClause(findActiveClause(this.$specContainer))
}

Menu.prototype.setActiveClause = function (clause) {
  this.$activeClause = clause;
  this.revealInToc(this.$activeClause);
}

Menu.prototype.revealInToc = function (path) {
  var current = this.$toc.querySelectorAll('li.revealed');
  for (var i = 0; i < current.length; i++) {
    current[i].classList.remove('revealed');
    current[i].classList.remove('revealed-leaf');
  }
  
  var current = this.$toc;
  var index = 0;
  while (index < path.length) {
    var children = current.children;
    for (var i = 0; i < children.length; i++) {
      if ('#' + path[index].id === children[i].children[1].getAttribute('href') ) {
        children[i].classList.add('revealed');
        if (index === path.length - 1) {
          children[i].classList.add('revealed-leaf');
          var rect = children[i].getBoundingClientRect();
          this.$toc.getBoundingClientRect().top
          var tocRect = this.$toc.getBoundingClientRect();
          if (rect.top + 10 > tocRect.bottom) {
            this.$toc.scrollTop = this.$toc.scrollTop + (rect.top - tocRect.bottom) + (rect.bottom - rect.top);
          } else if (rect.top < tocRect.top) {
            this.$toc.scrollTop = this.$toc.scrollTop - (tocRect.top - rect.top);
          }
        }
        current = children[i].querySelector('ol');
        index++;
        break;
      }      
    }
    
  }
}

function findActiveClause(root, path) {
  var clauses = new ClauseWalker(root);
  var $clause;
  var found = false;
  var path = path || [];
  
  while ($clause = clauses.nextNode()) {
    var rect = $clause.getBoundingClientRect();
    var $header = $clause.children[0];
    var marginTop = parseInt(getComputedStyle($header)["margin-top"]);
    
    if ((rect.top - marginTop) <= 0 && rect.bottom > 0) {
      found = true;
      return findActiveClause($clause, path.concat($clause)) || path;
    }
  }
  
  return path;
}

function ClauseWalker(root) {
  var previous;
  var treeWalker = document.createTreeWalker(
    root,
    NodeFilter.SHOW_ELEMENT,
    {
      acceptNode: function (node) {
        if (previous === node.parentNode) {
          return NodeFilter.FILTER_REJECT;
        } else {
          previous = node;
        }
        if (node.nodeName === 'EMU-CLAUSE' || node.nodeName === 'EMU-INTRO' || node.nodeName === 'EMU-ANNEX') {
          return NodeFilter.FILTER_ACCEPT;
        } else {
          return NodeFilter.FILTER_SKIP;
        }
      }
    },
    false
    );
  
  return treeWalker;
}

Menu.prototype.toggle = function () {
  this.$menu.classList.toggle('active');
}

Menu.prototype.show = function () {
  this.$menu.classList.add('active');
}

Menu.prototype.hide = function () {
  this.$menu.classList.remove('active');
}

Menu.prototype.isVisible = function() {
  return this.$menu.classList.contains('active');
}

Menu.prototype.showPins = function () {
  this.$pins.classList.add('active');
}

Menu.prototype.hidePins = function () {
  this.$pins.classList.remove('active');
}

Menu.prototype.addPinEntry = function (id) {
  var entry = this.search.biblio.byId[id];
  if (!entry) {
    // id was deleted after pin (or something) so remove it
    delete this._pinnedIds[id];
    this.persistPinEntries();
    return;
  }

  if (entry.type === 'clause') {
    var prefix;
    if (entry.number) {
      prefix = entry.number + ' ';
    } else {
      prefix = '';
    }
    this.$pinList.innerHTML += '<li><a href="#' + entry.id + '">' + prefix + entry.titleHTML + '</a></li>';
  } else {
    this.$pinList.innerHTML += '<li><a href="#' + entry.id + '">' + entry.key + '</a></li>';
  }

  if (Object.keys(this._pinnedIds).length === 0) {
    this.showPins();
  }
  this._pinnedIds[id] = true;
  this.persistPinEntries();
}

Menu.prototype.removePinEntry = function (id) {
  var item = this.$pinList.querySelector('a[href="#' + id + '"]').parentNode;
  this.$pinList.removeChild(item);
  delete this._pinnedIds[id];
  if (Object.keys(this._pinnedIds).length === 0) {
    this.hidePins();
  }

  this.persistPinEntries();
}

Menu.prototype.persistPinEntries = function () {
  try {
    if (!window.localStorage) return;
  } catch (e) {
    return;
  }

  localStorage.pinEntries = JSON.stringify(Object.keys(this._pinnedIds));
}

Menu.prototype.loadPinEntries = function () {
  try {
    if (!window.localStorage) return;
  } catch (e) {
    return;
  }
  
  var pinsString = window.localStorage.pinEntries;
  if (!pinsString) return;
  var pins = JSON.parse(pinsString);
  for(var i = 0; i < pins.length; i++) {
    this.addPinEntry(pins[i]);
  }
}

Menu.prototype.togglePinEntry = function (id) {
  if (!id) {
    id = this.$activeClause[this.$activeClause.length - 1].id;
  }

  if (this._pinnedIds[id]) {
    this.removePinEntry(id);
  } else {
    this.addPinEntry(id);
  }
}

Menu.prototype.selectPin = function (num) {
  document.location = this.$pinList.children[num].children[0].href;
}

var menu;
function init() {
  menu = new Menu();
  var $container = document.getElementById('spec-container');
  $container.addEventListener('mouseover', debounce(function (e) {
    Toolbox.activateIfMouseOver(e);
  }));
}

document.addEventListener('DOMContentLoaded', init);

function debounce(fn, opts) {
  opts = opts || {};
  var timeout;
  return function(e) {
    if (opts.stopPropagation) {
      e.stopPropagation();
    }
    var args = arguments;
    if (timeout) {
      clearTimeout(timeout);
    }
    timeout = setTimeout(function() {
      timeout = null;
      fn.apply(this, args);
    }.bind(this), 150);
  }
}

var CLAUSE_NODES = ['EMU-CLAUSE', 'EMU-INTRO', 'EMU-ANNEX'];
function findLocalReferences ($elem) {
  var name = $elem.innerHTML;
  var references = [];

  var parentClause = $elem.parentNode;
  while (parentClause && CLAUSE_NODES.indexOf(parentClause.nodeName) === -1) {
    parentClause = parentClause.parentNode;
  }

  if(!parentClause) return;

  var vars = parentClause.querySelectorAll('var');

  for (var i = 0; i < vars.length; i++) {
    var $var = vars[i];

    if ($var.innerHTML === name) {
      references.push($var);
    }
  }

  return references;
}

function toggleFindLocalReferences($elem) {
  var references = findLocalReferences($elem);
  if ($elem.classList.contains('referenced')) {
    references.forEach(function ($reference) {
      $reference.classList.remove('referenced');
    });
  } else {
    references.forEach(function ($reference) {
      $reference.classList.add('referenced');
    });
  }
}

function installFindLocalReferences () {
  document.addEventListener('click', function (e) {
    if (e.target.nodeName === 'VAR') {
      toggleFindLocalReferences(e.target);
    }
  });
}

document.addEventListener('DOMContentLoaded', installFindLocalReferences);




// The following license applies to the fuzzysearch function
// The MIT License (MIT)
// Copyright © 2015 Nicolas Bevacqua
// Copyright © 2016 Brian Terlson
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:

// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
function fuzzysearch (searchString, haystack, caseInsensitive) {
  var tlen = haystack.length;
  var qlen = searchString.length;
  var chunks = 1;
  var finding = false;
  var prefix = true;
  
  if (qlen > tlen) {
    return false;
  }
  
  if (qlen === tlen) {
    if (searchString === haystack) {
      return { caseMatch: true, chunks: 1, prefix: true };
    } else if (searchString.toLowerCase() === haystack.toLowerCase()) {
      return { caseMatch: false, chunks: 1, prefix: true };
    } else {
      return false;
    }
  }
  
  outer: for (var i = 0, j = 0; i < qlen; i++) {
    var nch = searchString[i];
    while (j < tlen) {
      var targetChar = haystack[j++];
      if (targetChar === nch) {
        finding = true;
        continue outer;
      }
      if (finding) {
        chunks++;
        finding = false;
      }
    }
    
    if (caseInsensitive) { return false }
    
    return fuzzysearch(searchString.toLowerCase(), haystack.toLowerCase(), true);
  }
  
  return { caseMatch: !caseInsensitive, chunks: chunks, prefix: j <= qlen };
}

var Toolbox = {
  init: function () {
    this.$container = document.createElement('div');
    this.$container.classList.add('toolbox');
    this.$permalink = document.createElement('a');
    this.$permalink.textContent = 'Permalink';
    this.$pinLink = document.createElement('a');
    this.$pinLink.textContent = 'Pin';
    this.$pinLink.setAttribute('href', '#');
    this.$pinLink.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      menu.togglePinEntry(this.entry.id);
    }.bind(this));

    this.$refsLink = document.createElement('a');
    this.$refsLink.setAttribute('href', '#');
    this.$refsLink.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      referencePane.showReferencesFor(this.entry);
    }.bind(this));
    this.$container.appendChild(this.$permalink);
    this.$container.appendChild(this.$pinLink);
    this.$container.appendChild(this.$refsLink);
    document.body.appendChild(this.$container);
  },

  activate: function (el, entry, target) {
    if (el === this._activeEl) return;
    this.active = true;
    this.entry = entry;
    this.$container.classList.add('active');
    this.top = el.offsetTop - this.$container.offsetHeight - 10;
    this.left = el.offsetLeft;
    this.$container.setAttribute('style', 'left: ' + this.left + 'px; top: ' + this.top + 'px');
    this.updatePermalink();
    this.updateReferences();
    this._activeEl = el;
    if (this.top < document.body.scrollTop && el === target) {
      // don't scroll unless it's a small thing (< 200px)
      this.$container.scrollIntoView();
    }
  },

  updatePermalink: function () {
    this.$permalink.setAttribute('href', '#' + this.entry.id);
  },

  updateReferences: function () {
    this.$refsLink.textContent = 'References (' + this.entry.referencingIds.length + ')';
  },

  activateIfMouseOver: function (e) {
    var ref = this.findReferenceUnder(e.target);
    if (ref && (!this.active || e.pageY > this._activeEl.offsetTop)) {
      var entry = menu.search.biblio.byId[ref.id];
      this.activate(ref.element, entry, e.target);
    } else if (this.active && ((e.pageY < this.top) || e.pageY > (this._activeEl.offsetTop + this._activeEl.offsetHeight))) {
      this.deactivate();
    }
  },

  findReferenceUnder: function (el) {
    while (el) {
      var parent = el.parentNode;
      if (el.nodeName === 'H1' && parent.nodeName.match(/EMU-CLAUSE|EMU-ANNEX|EMU-INTRO/) && parent.id) {
        return { element: el, id: parent.id };
      } else if (el.nodeName.match(/EMU-(?!CLAUSE|XREF|ANNEX|INTRO)|DFN/) &&
                el.id && el.id[0] !== '_') {
        if (el.nodeName === 'EMU-FIGURE' || el.nodeName === 'EMU-TABLE' || el.nodeName === 'EMU-EXAMPLE') {
          // return the figcaption element
          return { element: el.children[0].children[0], id: el.id };
        } else if (el.nodeName === 'EMU-PRODUCTION') {
          // return the LHS non-terminal element
          return { element: el.children[0], id: el.id };
        } else {
          return { element: el, id: el.id };
        }
      }
      el = parent;
    }
  },

  deactivate: function () {
    this.$container.classList.remove('active');
    this._activeEl = null;
    this.activeElBounds = null;
    this.active = false;
  }
}

var referencePane = {
  init: function() {
    this.$container = document.createElement('div');
    this.$container.setAttribute('id', 'references-pane-container');

    var $spacer = document.createElement('div');
    $spacer.setAttribute('id', 'references-pane-spacer');

    this.$pane = document.createElement('div');
    this.$pane.setAttribute('id', 'references-pane');

    this.$container.appendChild($spacer);
    this.$container.appendChild(this.$pane);

    this.$header = document.createElement('div');
    this.$header.classList.add('menu-pane-header');
    this.$header.textContent = 'References to ';
    this.$headerRefId = document.createElement('a');
    this.$header.appendChild(this.$headerRefId);
    this.$closeButton = document.createElement('span');
    this.$closeButton.setAttribute('id', 'references-pane-close');
    this.$closeButton.addEventListener('click', function (e) {
      this.deactivate();
    }.bind(this));
    this.$header.appendChild(this.$closeButton);

    this.$pane.appendChild(this.$header);
    var tableContainer = document.createElement('div');
    tableContainer.setAttribute('id', 'references-pane-table-container');

    this.$table = document.createElement('table');
    this.$table.setAttribute('id', 'references-pane-table');

    this.$tableBody = this.$table.createTBody();

    tableContainer.appendChild(this.$table);
    this.$pane.appendChild(tableContainer);

    menu.$specContainer.appendChild(this.$container);
  },

  activate: function () {
    this.$container.classList.add('active');
  },

  deactivate: function () {
    this.$container.classList.remove('active');
  },

  showReferencesFor(entry) {
    this.activate();
    var newBody = document.createElement('tbody');
    var previousId;
    var previousCell;
    var dupCount = 0;
    this.$headerRefId.textContent = '#' + entry.id;
    this.$headerRefId.setAttribute('href', '#' + entry.id);
    entry.referencingIds.map(function (id) {
      var target = document.getElementById(id);
      var cid = findParentClauseId(target);
      var clause = menu.search.biblio.byId[cid];
      var dupCount = 0;
      return { id: id, clause: clause }
    }).sort(function (a, b) {
      return sortByClauseNumber(a.clause, b.clause);
    }).forEach(function (record, i) {
      if (previousId === record.clause.id) {
        previousCell.innerHTML += ' (<a href="#' + record.id + '">' + (dupCount + 2) + '</a>)';
        dupCount++;
      } else {
        var row = newBody.insertRow();
        var cell = row.insertCell();
        cell.innerHTML = record.clause.number;
        cell = row.insertCell();
        cell.innerHTML = '<a href="#' + record.id + '">' + record.clause.titleHTML + '</a>';
        previousCell = cell;
        previousId = record.clause.id;
        dupCount = 0;
      }
    }, this);
    this.$table.removeChild(this.$tableBody);
    this.$tableBody = newBody;
    this.$table.appendChild(this.$tableBody);
  }
}
function findParentClauseId(node) {
  while (node && node.nodeName !== 'EMU-CLAUSE' && node.nodeName !== 'EMU-INTRO' && node.nodeName !== 'EMU-ANNEX') {
    node = node.parentNode;
  }
  if (!node) return null;
  return node.getAttribute('id');
}

function sortByClauseNumber(c1, c2) {
  var c1c = c1.number.split('.');
  var c2c = c2.number.split('.');

  for (var i = 0; i < c1c.length; i++) {
    if (i >= c2c.length) {
      return 1;
    }
    
    var c1 = c1c[i];
    var c2 = c2c[i];
    var c1cn = Number(c1);
    var c2cn = Number(c2);

    if (Number.isNaN(c1cn) && Number.isNaN(c2cn)) {
      if (c1 > c2) {
        return 1;
      } else if (c1 < c2) {
        return -1;
      }
    } else if (!Number.isNaN(c1cn) && Number.isNaN(c2cn)) {
      return -1;
    } else if (Number.isNaN(c1cn) && !Number.isNaN(c2cn)) {
      return 1;
    } else if(c1cn > c2cn) {
      return 1;
    } else if (c1cn < c2cn) {
      return -1;
    }
  }

  if (c1c.length === c2c.length) {
    return 0;
  }
  return -1;
}

document.addEventListener('DOMContentLoaded', function () {
  Toolbox.init();
  referencePane.init();
})
var CLAUSE_NODES = ['EMU-CLAUSE', 'EMU-INTRO', 'EMU-ANNEX'];
function findLocalReferences ($elem) {
  var name = $elem.innerHTML;
  var references = [];

  var parentClause = $elem.parentNode;
  while (parentClause && CLAUSE_NODES.indexOf(parentClause.nodeName) === -1) {
    parentClause = parentClause.parentNode;
  }

  if(!parentClause) return;

  var vars = parentClause.querySelectorAll('var');

  for (var i = 0; i < vars.length; i++) {
    var $var = vars[i];

    if ($var.innerHTML === name) {
      references.push($var);
    }
  }

  return references;
}

function toggleFindLocalReferences($elem) {
  var references = findLocalReferences($elem);
  if ($elem.classList.contains('referenced')) {
    references.forEach(function ($reference) {
      $reference.classList.remove('referenced');
    });
  } else {
    references.forEach(function ($reference) {
      $reference.classList.add('referenced');
    });
  }
}

function installFindLocalReferences () {
  document.addEventListener('click', function (e) {
    if (e.target.nodeName === 'VAR') {
      toggleFindLocalReferences(e.target);
    }
  });
}

document.addEventListener('DOMContentLoaded', installFindLocalReferences);
</script><style>body {
  display: flex;
  font-size: 18px;
  line-height: 1.5;
  font-family: Cambria, Palatino Linotype, Palatino, Liberation Serif, serif;
  padding: 0;
  margin: 0;
  color: #111;
}

#spec-container {
  padding: 0 20px;
  flex-grow: 1;
  flex-basis: 66%;
  box-sizing: border-box;
  overflow: hidden;
}

body.oldtoc {
  margin: 0 auto;
}

a {
    text-decoration: none;
    color: #206ca7;
}

a:visited {
  color: #206ca7;
}

a:hover {
    text-decoration: underline;
    color: #239dee;
}


code {
    font-weight: bold;
    font-family: Consolas, Monaco, monospace;
    white-space: pre;
}

pre code {
  font-weight: inherit;
}

pre code.hljs {
  background-color: #fff;
  margin: 0;
  padding: 0;
}

ol.toc {
    list-style: none;
    padding-left: 0;
}

ol.toc ol.toc {
    padding-left: 2ex;
    list-style: none;
}

var {
  color: #2aa198;
  transition: background-color 0.25s ease;
  cursor: pointer;
}

var.referenced {
  background-color: #ffff33;
}

emu-const {
  font-family: sans-serif;
}

emu-val {
  font-weight: bold;
}
emu-alg ol, emu-alg ol ol ol ol {
    list-style-type: decimal;
}

emu-alg ol ol, emu-alg ol ol ol ol ol {
    list-style-type: lower-alpha;
}

emu-alg ol ol ol, ol ol ol ol ol ol {
    list-style-type: lower-roman;
}

emu-eqn {
  display: block;
  margin-left: 4em;
}

emu-eqn.inline {
  display: inline;
  margin: 0;
}

emu-eqn div:first-child {
  margin-left: -2em;
}

emu-note {
    margin: 1em 0;
    color: #666;
    border-left: 5px solid #ccc;
    display: flex;
    flex-direction: row;
}

emu-note > span.note {
    flex-basis: 100px;
    min-width: 100px;
    flex-grow: 0;
    flex-shrink: 1;
    text-transform: uppercase;
    padding-left: 5px;
}

emu-note[type=editor] {
  border-left-color: #faa;
}

emu-note > div.note-contents {
  flex-grow: 1;
  flex-shrink: 1;
}

emu-note > div.note-contents > p:first-of-type {
  margin-top: 0;
}

emu-note > div.note-contents > p:last-of-type {
  margin-bottom: 0;
}

emu-figure {
  display: block;
}

emu-example {
  display: block;
  margin: 1em 3em;
}

emu-example figure figcaption {
  margin-top: 0.5em;
  text-align: left;
}

emu-figure figure,
emu-example figure,
emu-table figure {
  display: flex;
  flex-direction: column;
  align-items: center;
}

emu-production {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
    margin-left: 5ex;
}

emu-grammar.inline, emu-production.inline,
emu-grammar.inline emu-production emu-rhs, emu-production.inline emu-rhs,
emu-grammar[collapsed] emu-production emu-rhs, emu-production[collapsed] emu-rhs {
    display: inline;
    padding-left: 1ex;
    margin-left: 0;
}

emu-grammar[collapsed] emu-production, emu-production[collapsed] {
    margin: 0;
}

emu-constraints {
    font-size: .75em;
    margin-right: 1ex;
}

emu-gann {
    margin-right: 1ex;
}

emu-gann emu-t:last-child,
emu-gann emu-nt:last-child {
    margin-right: 0;
}

emu-geq {
    margin-left: 1ex;
    font-weight: bold;
}

emu-oneof {
    font-weight: bold;
    margin-left: 1ex;
}

emu-nt {
    display: inline-block;
    font-style: italic;
    white-space: nowrap;
    text-indent: 0;
}

emu-nt a, emu-nt a:visited {
  color: #333;
}

emu-rhs emu-nt {
    margin-right: 1ex;
}

emu-t {
    display: inline-block;
    font-family: monospace;
    font-weight: bold;
    white-space: nowrap;
    text-indent: 0;
}

emu-production emu-t {
    margin-right: 1ex;
}

emu-rhs {
    display: block;
    padding-left: 75px;
    text-indent: -25px;
}

emu-mods {
    font-size: .85em;
    vertical-align: sub;
    font-style: normal;
    font-weight: normal;
}

emu-production[collapsed] emu-mods {
  display: none;
}

emu-params, emu-opt {
  margin-right: 1ex;
  font-family: monospace;
}

emu-params, emu-constraints {
  color: #2aa198;
}

emu-opt {
  color: #b58900;
}

emu-gprose {
    font-size: 0.9em;
    font-family: Helvetica, Arial, sans-serif;
}

h1.shortname {
  color: #f60;
  font-size: 1.5em;
  margin: 0;
}

h1.version {
  color: #f60;
  font-size: 1.5em;
  margin: 0;
}

h1.title {
  margin-top: 0;
  color: #f60;
}

h1.first {
  margin-top: 0;
}

h1, h2, h3, h4, h5, h6 {
    position: relative;
}

h1 .secnum {
  text-decoration: none;
  margin-right: 10px;
}

h1 span.title {
  order: 2;
}


h1 { font-size: 2.67em; margin-top: 2em; margin-bottom: 0; line-height: 1em;}
h2 { font-size: 2em; }
h3 { font-size: 1.56em; }
h4 { font-size: 1.25em; }
h5 { font-size: 1.11em; }
h6 { font-size: 1em; }

h1:hover span.utils {
  display: block;
}

span.utils {
  font-size: 18px;
  line-height: 18px;
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  font-weight: normal;
}

span.utils:before {
    content: "⤷";
    display: inline-block;
    padding: 0 5px;
}

span.utils > * {
  display: inline-block;
  margin-right: 20px;
}

h1 span.utils span.anchor a,
h2 span.utils span.anchor a,
h3 span.utils span.anchor a,
h4 span.utils span.anchor a,
h5 span.utils span.anchor a,
h6 span.utils span.anchor a {
  text-decoration: none;
  font-variant: small-caps;
}

h1 span.utils span.anchor a:hover,
h2 span.utils span.anchor a:hover,
h3 span.utils span.anchor a:hover,
h4 span.utils span.anchor a:hover,
h5 span.utils span.anchor a:hover,
h6 span.utils span.anchor a:hover {
  color: #333;
}

emu-intro h1, emu-clause h1, emu-annex h1 { font-size: 2em; }
emu-intro h2, emu-clause h2, emu-annex h2 { font-size: 1.56em; }
emu-intro h3, emu-clause h3, emu-annex h3 { font-size: 1.25em; }
emu-intro h4, emu-clause h4, emu-annex h4 { font-size: 1.11em; }
emu-intro h5, emu-clause h5, emu-annex h5 { font-size: 1em; }
emu-intro h6, emu-clause h6, emu-annex h6 { font-size: 0.9em; }
emu-intro emu-intro h1, emu-clause emu-clause h1, emu-annex emu-annex h1 { font-size: 1.56em; }
emu-intro emu-intro h2, emu-clause emu-clause h2, emu-annex emu-annex h2 { font-size: 1.25em; }
emu-intro emu-intro h3, emu-clause emu-clause h3, emu-annex emu-annex h3 { font-size: 1.11em; }
emu-intro emu-intro h4, emu-clause emu-clause h4, emu-annex emu-annex h4 { font-size: 1em; }
emu-intro emu-intro h5, emu-clause emu-clause h5, emu-annex emu-annex h5 { font-size: 0.9em; }
emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex h1 { font-size: 1.25em; }
emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex h2 { font-size: 1.11em; }
emu-intro emu-intro emu-intro h3, emu-clause emu-clause emu-clause h3, emu-annex emu-annex emu-annex h3 { font-size: 1em; }
emu-intro emu-intro emu-intro h4, emu-clause emu-clause emu-clause h4, emu-annex emu-annex emu-annex h4 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex h1 { font-size: 1.11em; }
emu-intro emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex emu-annex h2 { font-size: 1em; }
emu-intro emu-intro emu-intro emu-intro h3, emu-clause emu-clause emu-clause emu-clause h3, emu-annex emu-annex emu-annex emu-annex h3 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex emu-annex h1 { font-size: 1em; }
emu-intro emu-intro emu-intro emu-intro emu-intro h2, emu-clause emu-clause emu-clause emu-clause emu-clause h2, emu-annex emu-annex emu-annex emu-annex emu-annex h2 { font-size: 0.9em; }
emu-intro emu-intro emu-intro emu-intro emu-intro emu-intro h1, emu-clause emu-clause emu-clause emu-clause emu-clause emu-clause h1, emu-annex emu-annex emu-annex emu-annex emu-annex emu-annex h1 { font-size: 0.9em }

emu-clause, emu-intro, emu-annex {
    display: block;
}

/* Figures and tables */
figure { display: block; margin: 1em 0 3em 0; }
figure object { display: block; margin: 0 auto; }
figure table.real-table { margin: 0 auto; }
figure figcaption {
    display: block;
    color: #555555;
    font-weight: bold;
    text-align: center;
}

emu-table table {
  margin: 0 auto;
}

emu-table table, table.real-table {
    border-collapse: collapse;
}

emu-table td, emu-table th, table.real-table td, table.real-table th {
    border: 1px solid black;
    padding: 0.4em;
    vertical-align: baseline;
}
emu-table th, emu-table thead td, table.real-table th {
    background-color: #eeeeee;
}

/* Note: the left content edges of table.lightweight-table >tbody >tr >td
   and div.display line up. */
table.lightweight-table {
    border-collapse: collapse;
    margin: 0 0 0 1.5em;
}
table.lightweight-table td, table.lightweight-table th {
    border: none;
    padding: 0 0.5em;
    vertical-align: baseline;
}

/* diff styles */
ins {
    background-color: #e0f8e0;
    text-decoration: none;
    border-bottom: 1px solid #396;
}

del {
    background-color: #fee;
}

ins.block, del.block,
emu-production > ins, emu-production > del,
emu-grammar > ins, emu-grammar > del {
  display: block;
}
emu-rhs > ins, emu-rhs > del { 
  display: inline;
}

tr.ins > td > ins {
  border-bottom: none;
}

tr.ins > td {
  background-color: #e0f8e0;
}

tr.del > td {
  background-color: #fee;
}

/* Menu Styles */
#menu-toggle {
  font-size: 2em;

  position: fixed;
  top: 0;
  left: 0;
  width: 1.5em;
  height: 1.5em;
  z-index: 3;
  visibility: hidden;
  color: #1567a2;
  background-color: #fff;

  line-height: 1.5em;
  text-align: center;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;;

  cursor: pointer;
}

#menu {
  display: flex;
  flex-direction: column;
  width: 33%; height: 100vh;
  max-width: 500px;
  box-sizing: border-box;
  background-color: #ddd;
  overflow: hidden;
  transition: opacity 0.1s linear;
  padding: 0 5px;
  position: fixed;
  left: 0; top: 0;
  border-right: 2px solid #bbb;

  z-index: 2;
}

#menu-spacer {
  flex-basis: 33%;
  max-width: 500px;
  flex-grow: 0;
  flex-shrink: 0;
}

#menu a {
  color: #1567a2;
}

#menu.active {
  display: flex;
  opacity: 1;
  z-index: 2;
}

#menu-pins {
  flex-grow: 1;
  display: none;
}

#menu-pins.active {
  display: block;
}

#menu-pins-list {
  margin: 0;
  padding: 0;
  counter-reset: pins-counter;
}

#menu-pins-list > li:before {
  content: counter(pins-counter);
  counter-increment: pins-counter;
  display: inline-block;
  width: 25px;
  text-align: center;
  border: 1px solid #bbb;
  padding: 2px;
  margin: 4px;
  box-sizing: border-box;
  line-height: 1em;
  background-color: #ccc;
  border-radius: 4px;
}
#menu-toc > ol {
  padding: 0;
  flex-grow: 1;
}

#menu-toc > ol li {
  padding: 0;
}

#menu-toc > ol , #menu-toc > ol ol {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

#menu-toc > ol ol {
  padding-left: 0.75em;
}

#menu-toc li {
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}

#menu-toc .item-toggle {
  display: inline-block;
  transform: rotate(-45deg) translate(-5px, -5px);
  transition: transform 0.1s ease;
  text-align: center;
  width: 20px;

  color: #aab;

  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;;

  cursor: pointer;
}

#menu-toc .item-toggle-none {
  display: inline-block;
  width: 20px;
}

#menu-toc li.active > .item-toggle {
  transform: rotate(45deg) translate(-5px, -5px);
}

#menu-toc li > ol {
  display: none;
}

#menu-toc li.active > ol {
  display: block;
}

#menu-toc li.revealed > a {
  background-color: #bbb;
  font-weight: bold;
  /*
  background-color: #222;
  color: #c6d8e4;
  */
}

#menu-toc li.revealed-leaf> a {
  color: #206ca7;
  /*
  background-color: #222;
  color: #c6d8e4;
  */
}

#menu-toc li.revealed > .item-toggle {
  transform: rotate(45deg) translate(-5px, -5px);
}

#menu-toc li.revealed > ol {
  display: block;
}

#menu-toc li > a {
  padding: 2px 5px;
}

#menu > * {
  margin-bottom: 5px;
}

.menu-pane-header {
  padding: 0 5px;
  text-transform: uppercase;
  background-color: #aaa;
  color: #335;
  font-weight: bold;
  letter-spacing: 2px;
  flex-grow: 0;
  flex-shrink: 0;
  font-size: 0.8em;
}

#menu-toc {
  display: flex;
  flex-direction: column;
  width: 100%;
  overflow: hidden;
  flex-grow: 1;
}

#menu-toc ol.toc {
  overflow-x: hidden;
  overflow-y: auto;
}

#menu-search {
  position: relative;
  flex-grow: 0;
  flex-shrink: 0;
  width: 100%;
  
  display: flex;
  flex-direction: column;
  
  max-height: 300px;
}

#menu-trace-list {
  display: none;
}

#menu-search-box {
  box-sizing: border-box;
  display: block;
  width: 100%;
  margin: 5px 0 0 0;
  font-size: 1em;
  padding: 2px;
  background-color: #bbb;
  border: 1px solid #999;
}

#menu-search-results {
  overflow-x: hidden;
  overflow-y: auto;
}

li.menu-search-result-clause:before {
    content: 'clause';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%;
}
li.menu-search-result-op:before {
    content: 'op';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%;
}

li.menu-search-result-prod:before {
    content: 'prod';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%
}


li.menu-search-result-term:before {
    content: 'term';
    width: 40px;
    display: inline-block;
    text-align: right;
    padding-right: 1ex;
    color: #666;
    font-size: 75%
}

#menu-search-results ul {
  padding: 0 5px;
  margin: 0;
}

#menu-search-results li {
  white-space: nowrap;
  text-overflow: ellipsis;
}


#menu-trace-list {
  counter-reset: item;
  margin: 0 0 0 20px;
  padding: 0;
}
#menu-trace-list li {
  display: block;
  white-space: nowrap;
}

#menu-trace-list li .secnum:after {
  content: " ";
}
#menu-trace-list li:before {
    content: counter(item) " ";
    background-color: #222;
    counter-increment: item;
    color: #999;
    width: 20px;
    height: 20px;
    line-height: 20px;
    display: inline-block;
    text-align: center;
    margin: 2px 4px 2px 0;
}

@media (max-width: 1000px) {
  body {
    margin: 0;
    display: block;
  }

  #menu {
    display: none;
    padding-top: 3em;
    width: 450px;
  }

  #menu.active {
    position: fixed;
    height: 100%;
    left: 0;
    top: 0;
    right: 300px;
  }

  #menu-toggle {
    visibility: visible;
  }

  #spec-container {
    padding: 0 5px;
  }

  #references-pane-spacer {
    display: none;
  }
}

@media only screen and (max-width: 800px) {
  #menu {
    width: 100%;
  }

  h1 .secnum:empty {
    margin: 0; padding: 0;
  }
}


/* Toolbox */
.toolbox {
	position: absolute;
	background: #ddd;
	border: 1px solid #aaa;
  display: none;
  color: #eee;
  padding: 5px;
  border-radius: 3px;
}

.toolbox.active {
  display: inline-block;
}

.toolbox a {
  text-decoration: none;
  padding: 0 5px;
}

.toolbox a:hover {
  text-decoration: underline;
}

.toolbox:after, .toolbox:before {
	top: 100%;
	left: 15px;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

.toolbox:after {
	border-color: rgba(0, 0, 0, 0);
	border-top-color: #ddd;
	border-width: 10px;
	margin-left: -10px;
}
.toolbox:before {
	border-color: rgba(204, 204, 204, 0);
	border-top-color: #aaa;
	border-width: 12px;
	margin-left: -12px;
}

#references-pane-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 250px;
  display: none;
  background-color: #ddd;
  z-index: 1;
}

#references-pane-table-container {
  overflow-x: hidden;
  overflow-y: auto;
}

#references-pane-spacer {
  flex-basis: 33%;
  max-width: 500px;
}

#references-pane {
  flex-grow: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

#references-pane-container.active {
  display: flex;
}

#references-pane-close:after {
  content: '✖';
  float: right;
  cursor: pointer;
}

#references-pane table tr td:first-child {
  text-align: right;
  padding-right: 5px;
}

@media print {
  #menu-toggle {
    display: none; 
  }
}
</style></head><body><div id="menu-toggle">☰</div><div id="menu-spacer"></div><div id="menu"><div id="menu-search"><input type="text" id="menu-search-box" placeholder="Search..."><div id="menu-search-results" class="inactive"></div></div><div id="menu-pins"><div class="menu-pane-header">Pins</div><ul id="menu-pins-list"></ul></div><div class="menu-pane-header">Table of Contents</div><div id="menu-toc"><ol class="toc"><li><span class="item-toggle">◢</span><a href="#sec-weak-ref-objects" title=" WeakRef Objects  "><span class="secnum">1</span>  WeakRef Objects  </a><ol class="toc"><li><span class="item-toggle">◢</span><a href="#sec-weak-ref-constructor" title="The WeakRef Constructor"><span class="secnum">1.1</span> The WeakRef Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-weak-ref-target" title=" WeakRef ( target )  "><span class="secnum">1.1.1</span>  WeakRef ( <var>target</var> )  </a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-weak-ref-constructor" title="Properties of the WeakRef Constructor"><span class="secnum">1.2</span> Properties of the WeakRef Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-weak-ref.prototype" title="WeakRef.prototype"><span class="secnum">1.2.1</span> WeakRef.prototype</a></li><li><span class="item-toggle-none"></span><a href="#sec-get-weak-ref-@@species" title="get WeakRef [ @@species ]"><span class="secnum">1.2.2</span> get WeakRef [ @@species ]</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-weak-ref-prototype-object" title="Properties of the WeakRef Prototype Object"><span class="secnum">1.3</span> Properties of the WeakRef Prototype Object</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-weak-ref.prototype.deref" title="WeakRef.prototype.deref ( )"><span class="secnum">1.3.1</span> WeakRef.prototype.deref ( )</a></li></ol></li><li><span class="item-toggle-none"></span><a href="#sec-properties-of-weak-ref-instances" title="Properties of WeakRef Instances"><span class="secnum">1.4</span> Properties of WeakRef Instances</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-finalization-group-objects" title=" FinalizationGroup Objects  "><span class="secnum">2</span>  FinalizationGroup Objects  </a><ol class="toc"><li><span class="item-toggle">◢</span><a href="#sec-finalization-group-constructor" title="The FinalizationGroup Constructor"><span class="secnum">2.1</span> The FinalizationGroup Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-finalization-group-cleanup-callback" title=" FinalizationGroup ( cleanupCallback )  "><span class="secnum">2.1.1</span>  FinalizationGroup ( <var>cleanupCallback</var> )  </a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-finalization-group-constructor" title="Properties of the FinalizationGroup Constructor"><span class="secnum">2.2</span> Properties of the FinalizationGroup Constructor</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-finalization-group.prototype" title="FinalizationGroup.prototype"><span class="secnum">2.2.1</span> FinalizationGroup.prototype</a></li><li><span class="item-toggle-none"></span><a href="#sec-get-finalization-group-@@species" title="get FinalizationGroup [ @@species ]"><span class="secnum">2.2.2</span> get FinalizationGroup [ @@species ]</a></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-properties-of-the-finalization-group-prototype-object" title="Properties of the FinalizationGroup Prototype Object"><span class="secnum">2.3</span> Properties of the FinalizationGroup Prototype Object</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-finalization-group.prototype.constructor" title="FinalizationGroup.prototype.constructor"><span class="secnum">2.3.1</span> FinalizationGroup.prototype.constructor</a></li><li><span class="item-toggle-none"></span><a href="#sec-finalization-group.prototype.register" title="FinalizationGroup.prototype.register ( target , holdings [, unregisterToken ]  )"><span class="secnum">2.3.2</span> FinalizationGroup.prototype.register ( <var>target</var> , <var>holdings</var> [, <var>unregisterToken</var> ]  )</a></li><li><span class="item-toggle-none"></span><a href="#sec-finalization-group.prototype.unregister" title="FinalizationGroup.prototype.unregister ( unregisterToken )"><span class="secnum">2.3.3</span> FinalizationGroup.prototype.unregister ( <var>unregisterToken</var> )</a></li><li><span class="item-toggle-none"></span><a href="#sec-finalization-group.prototype.cleanupSome" title="FinalizationGroup.prototype.cleanupSome ( [ callback ] )"><span class="secnum">2.3.4</span> FinalizationGroup.prototype.cleanupSome ( [ <var>callback</var> ] )</a></li></ol></li><li><span class="item-toggle-none"></span><a href="#sec-properties-of-finalization-group-instances" title="Properties of FinalizationGroup Instances"><span class="secnum">2.4</span> Properties of FinalizationGroup Instances</a></li><li><span class="item-toggle">◢</span><a href="#sec-finalization-group-cleanup-iterator-objects" title="FinalizationGroup Cleanup Iterator Objects"><span class="secnum">2.5</span> FinalizationGroup Cleanup Iterator Objects</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-createfinalizationgroupcleanupiterator" title="CreateFinalizationGroupCleanupIterator ( finalizationGroup )"><span class="secnum">2.5.1</span> CreateFinalizationGroupCleanupIterator ( <var>finalizationGroup</var> )</a></li><li><span class="item-toggle">◢</span><a href="#sec-%finalizationgroupcleanupiterator%-object" title="The %FinalizationGroupCleanupIteratorPrototype% Object"><span class="secnum">2.5.2</span> The %FinalizationGroupCleanupIteratorPrototype% Object</a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-%finalizationgroupcleanupiterator%.next" title="%FinalizationGroupCleanupIteratorPrototype%.next ( )"><span class="secnum">2.5.2.1</span> %FinalizationGroupCleanupIteratorPrototype%.next ( )</a></li><li><span class="item-toggle-none"></span><a href="#sec-%finalizationgroupcleanupiteratorprototype%-@@tostringtag" title="%FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]"><span class="secnum">2.5.2.2</span> %FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]</a></li></ol></li><li><span class="item-toggle-none"></span><a href="#sec-properties-of-finalization-group-cleanup-iterator-instances" title="Properties of FinalizationGroup Cleanup Iterator Instances"><span class="secnum">2.5.3</span> Properties of FinalizationGroup Cleanup Iterator Instances</a></li></ol></li></ol></li><li><span class="item-toggle">◢</span><a href="#sec-abstract-jobs" title=" Abstract Jobs  "><span class="secnum">3</span>  Abstract Jobs  </a><ol class="toc"><li><span class="item-toggle-none"></span><a href="#sec-do-agent-finalization" title=" DoAgentFinalization ( )"><span class="secnum">3.1</span>  DoAgentFinalization ( )</a></li><li><span class="item-toggle-none"></span><a href="#sec-check-for-empty-cells" title=" CheckForEmptyCells ( finalizationGroup )  "><span class="secnum">3.2</span>  CheckForEmptyCells ( <var>finalizationGroup</var> )  </a></li><li><span class="item-toggle-none"></span><a href="#sec-finalization-group-cleanup-job" title=" FinalizationGroupCleanupJob ( finalizationGroup [ , callback ] )  "><span class="secnum">3.3</span>  FinalizationGroupCleanupJob ( <var>finalizationGroup</var> [ , <var>callback</var> ] )  </a></li><li><span class="item-toggle-none"></span><a href="#sec-keepduringjob" title="KeepDuringJob ( object )"><span class="secnum">3.4</span> KeepDuringJob ( <var>object</var> )</a></li></ol></li></ol></div></div><div id="spec-container"><emu-import href="./weak-ref.html"><emu-clause id="sec-weak-ref-objects">
  <h1 class="first"><span class="secnum">1</span> WeakRef Objects  </h1>
  <p>
    A WeakRef is an object that is used to refer to a target object
    without preserving it from garbage collection. WeakRefs can
    dereference to allow access to the target object, if the target
    object hasn't been reclaimed by garbage collection.
  
  </p>

  <emu-clause id="sec-weak-ref-constructor">
    <h1><span class="secnum">1.1</span>The WeakRef Constructor</h1>
    <p>The WeakRef constructor:</p>
    <ul>
      <li>is the intrinsic object %WeakRef%.</li>
      <li>
        is the initial value of the <code>WeakRef</code> property of the %System%
        object.
      
      </li>
      <li>
        creates and initializes a new WeakRef object when called as a
        constructor.
      
      </li>
      <li>
        is not intended to be called as a function and will throw an
        exception when called in that manner.
      
      </li>
      <li>
        is designed to be subclassable. It may be used as the value
        in an <code>extends</code> clause of a class definition. Subclass
        constructors that intend to inherit the specified <code>WeakRef</code>
        behaviour must include a <code>super</code> call to the <code>WeakRef</code> constructor
        to create and initialize the subclass instance with the internal
        state necessary to support the <code>WeakRef.prototype</code> built-in
        methods.
      
      </li>
    </ul>

    <emu-clause id="sec-weak-ref-target">
      <h1><span class="secnum">1.1.1</span> WeakRef ( <var>target</var> )  </h1>
      <p>
        When the <code>WeakRef</code> function is called with argument <var>target</var>,
        the following steps are taken:
      
      </p>
      <emu-alg><ol><li>If NewTarget is <emu-val>undefined</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <emu-xref aoid="Type" id="_ref_0"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>target</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>weakRef</var> be ?&nbsp;<emu-xref aoid="OrdinaryCreateFromConstructor" id="_ref_1"><a href="https://tc39.github.io/ecma262/#sec-ordinarycreatefromconstructor">OrdinaryCreateFromConstructor</a></emu-xref>(NewTarget,
        <code>"%WeakRefPrototype%"</code>, « [[Target]] »).</li><li>Perfom !&nbsp;<emu-xref aoid="KeepDuringJob" id="_ref_2"><a href="#sec-keepduringjob">KeepDuringJob</a></emu-xref>(<var>target</var>).</li><li>Set <var>weakRef</var>.[[Target]] to <var>target</var>.</li><li>Return <var>weakRef</var>.
    </li></ol></emu-alg></emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-weak-ref-constructor">
    <h1><span class="secnum">1.2</span>Properties of the WeakRef Constructor</h1>
    <p>The WeakRef constructor:</p>
    <ul>
      <li>
        has a [[Prototype]] internal slot whose value is the intrinsic
        object <emu-xref href="#sec-properties-of-the-function-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-function-prototype-object">%FunctionPrototype%</a></emu-xref>.
      
      </li>
      <li>has the following properties:</li>
    </ul>

    <emu-clause id="sec-weak-ref.prototype">
      <h1><span class="secnum">1.2.1</span>WeakRef.prototype</h1>
      <p>
        The initial value of <code>WeakRef.prototype</code> is the intrinsic
        <emu-xref href="#sec-properties-of-the-weak-ref-prototype-object" id="_ref_3"><a href="#sec-properties-of-the-weak-ref-prototype-object">%WeakRefPrototype%</a></emu-xref> object.
      
      </p>
      <p>
        This property has the attributes { [[Writable]]: <emu-val>false</emu-val>,
        [[Enumerable]]: <emu-val>false</emu-val>, [[Configurable]]: <emu-val>false</emu-val> }.
      
      </p>
    </emu-clause>

    <emu-clause id="sec-get-weak-ref-@@species">
      <h1><span class="secnum">1.2.2</span>get WeakRef [ @@species ]</h1>

      <p>
        <code>WeakRef[@@species]</code> is an accessor property whose set
        accessor function is <emu-val>undefined</emu-val>. Its get accessor function
        performs the following steps:
      
      </p>

      <emu-alg><ol><li>Return the <emu-val>this</emu-val> value.
      </li></ol></emu-alg>
      <p>The value of the <code>name</code> property of this function is <code>"get [Symbol.species]"</code>.</p>
      <emu-note><span class="note">Note</span><div class="note-contents">
        <p>
          Methods that create derived collection objects should call
          @@species to determine the constructor to use to create the
          derived objects. Subclass constructor may over-ride
          @@species to change the default constructor assignment.
        
        </p>
      </div></emu-note>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-weak-ref-prototype-object">
    <h1><span class="secnum">1.3</span>Properties of the WeakRef Prototype Object</h1>
    <p>The WeakRef prototype object:</p>
    <ul>
      <li>is the intrinsic object  <dfn>%WeakRefPrototype%</dfn>.</li>
      <li>
        has a [[Prototype]] internal slot whose value is the intrinsic
        object <emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>.
      
      </li>
      <li>is an ordinary object.</li>
      <li>does not have a [[Target]] internal slot.</li>
    </ul>

    <emu-clause id="sec-weak-ref.prototype.deref">
      <h1><span class="secnum">1.3.1</span>WeakRef.prototype.deref ( )</h1>
      <p>The following steps are taken:</p>
      <emu-alg><ol><li>Let <var>weakRef</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_4"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>weakRef</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>weakRef</var> does not have a [[Target]] internal slot,
        throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>target</var> be the value of <var>weakRef</var>.[[Target]].</li><li>If <var>target</var> is not <emu-const>empty</emu-const>,<ol><li>Perform !&nbsp;<emu-xref aoid="KeepDuringJob" id="_ref_5"><a href="#sec-keepduringjob">KeepDuringJob</a></emu-xref>(<var>target</var>).</li><li>Return <var>target</var>.</li></ol></li><li>Return <emu-val>undefined</emu-val>.
      </li></ol></emu-alg>

      <emu-note><span class="note">Note</span><div class="note-contents">
        If the WeakRef returns a <var>target</var> Object that is not
        <emu-val>undefined</emu-val>, then this <var>target</var> object should not be garbage
        collected in that turn. The <emu-xref aoid="KeepDuringJob" id="_ref_6"><a href="#sec-keepduringjob">KeepDuringJob</a></emu-xref> operation makes sure
        read consistency is maintained. 

        <pre>          target = { foo: function() {} };
          let weakRef = new WeakRef(target);

          ... later ...

          if (weakRef.deref()) {
            weakRef.deref().foo();
          }
        </pre>

        In the above example, if the first deref evaluates to true
        then the second deref can not fail.
      
      </div></emu-note>
    </emu-clause>

  </emu-clause>

  <emu-clause id="sec-properties-of-weak-ref-instances">
    <h1><span class="secnum">1.4</span>Properties of WeakRef Instances</h1>
    <p>
      WeakRef instances are ordinary objects that inherit properties from
      the WeakRef prototype. WeakRef instances also have a [[Target]]
      internal slot.
    
    </p>
  </emu-clause>
</emu-clause>
</emu-import>
<emu-import href="./finalization-group.html"><emu-clause id="sec-finalization-group-objects">
  <h1><span class="secnum">2</span> FinalizationGroup Objects  </h1>
  <p>
    A FinalizationGroup is an object that manages registeration and
    unregisteration of cleanup operations that are performed when
    target objects are garbage collected.
  
  </p>

  <emu-clause id="sec-finalization-group-constructor">
    <h1><span class="secnum">2.1</span>The FinalizationGroup Constructor</h1>
    <p>The FinalizationGroup constructor:</p>
    <ul>
      <li>is the intrinsic object  <dfn>%FinalizationGroup%</dfn>.</li>
      <li>
        is the initial value of the <code>FinalizationGroup</code> property of
        the %System% object.
      
      </li>
      <li>
        creates and initializes a new FinalizationGroup object when
        called as a constructor.
      
      </li>
      <li>
        is not intended to be called as a function and will throw an
        exception when called in that manner.
      
      </li>
      <li>
        is designed to be subclassable. It may be used as the value in
        an <code>extends</code> clause of a class definition. Subclass
        constructors that intend to inherit the specified
        <code>FinalizationGroup</code> behaviour must include a <code>super</code> call to
        the <code>FinalizationGroup</code> constructor to create and initialize
        the subclass instance with the internal state necessary to
        support the <code>FinalizationGroup.prototype</code> built-in methods.
      
      </li>
    </ul>

    <emu-clause id="sec-finalization-group-cleanup-callback">
      <h1><span class="secnum">2.1.1</span> FinalizationGroup ( <var>cleanupCallback</var> )  </h1>
      <p>
        When the <code>FinalizationGroup</code> function is called with argument <var>cleanupCallback</var>,
        the following steps are taken:
      
      </p>
      <emu-alg><ol><li>If NewTarget is <emu-val>undefined</emu-val>, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <emu-xref aoid="Type" id="_ref_7"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>cleanupCallback</var>) is not Callable, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>finalizationGroup</var> be ?&nbsp;<emu-xref aoid="OrdinaryCreateFromConstructor" id="_ref_8"><a href="https://tc39.github.io/ecma262/#sec-ordinarycreatefromconstructor">OrdinaryCreateFromConstructor</a></emu-xref>(NewTarget,
        <code>"%FinalizationGroupPrototype%"</code>, « [[CleanupCallback]], [[Cells]] »).</li><li>Set <var>finalizationGroup</var>.[[CleanupCallback]] to <var>cleanupCallback</var>.</li><li>Set <var>finalizationGroup</var>.[[Cells]] to be an empty <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.</li><li>Let <var>agent</var> be the surrounding agent.</li><li>Append <var>finalizationGroup</var> to <var>agent</var>.[[FinalizationGroups]].</li><li>Return <var>finalizationGroup</var>.
    </li></ol></emu-alg></emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-finalization-group-constructor">
    <h1><span class="secnum">2.2</span>Properties of the FinalizationGroup Constructor</h1>
    <p>The FinalizationGroup constructor:</p>
    <ul>
      <li>
        has a [[Prototype]] internal slot whose value is the intrinsic
        object <emu-xref href="#sec-properties-of-the-function-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-function-prototype-object">%FunctionPrototype%</a></emu-xref>.
      
      </li>
      <li>has the following properties:</li>
    </ul>

    <emu-clause id="sec-finalization-group.prototype">
      <h1><span class="secnum">2.2.1</span>FinalizationGroup.prototype</h1>
      <p>
        The initial value of <code>FinalizationGroup.prototype</code> is the
        intrinsic <emu-xref href="#sec-properties-of-the-finalization-group-prototype-object" id="_ref_9"><a href="#sec-properties-of-the-finalization-group-prototype-object">%FinalizationGroupPrototype%</a></emu-xref> object.
      
      </p>
      <p>
        This property has the attributes { [[Writable]]: <emu-val>false</emu-val>,
        [[Enumerable]]: <emu-val>false</emu-val>, [[Configurable]]: <emu-val>false</emu-val> }.
      
      </p>
    </emu-clause>

    <emu-clause id="sec-get-finalization-group-@@species">
      <h1><span class="secnum">2.2.2</span>get FinalizationGroup [ @@species ]</h1>

      <p>
        <code>FinalizationGroup[@@species]</code> is an accessor property whose
        set accessor function is <emu-val>undefined</emu-val>. Its get accessor
        function performs the following steps:
      
      </p>

      <emu-alg><ol><li>Return the <emu-val>this</emu-val> value.
      </li></ol></emu-alg>
      <p>
        The value of the <code>name</code> property of this function is <code>"get [Symbol.species]"</code>.
      
      </p>
      <emu-note><span class="note">Note</span><div class="note-contents">
        <p>
          Methods that create derived collection objects should call
          @@species to determine the constructor to use to create the
          derived objects. Subclass constructor may over-ride
          @@species to change the default constructor assignment.
        
        </p>
      </div></emu-note>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-finalization-group-prototype-object">
    <h1><span class="secnum">2.3</span>Properties of the FinalizationGroup Prototype Object</h1>
    <p>The FinalizationGroup prototype object:</p>
    <ul>
      <li>is the intrinsic object  <dfn>%FinalizationGroupPrototype%</dfn>.</li>
      <li>
        has a [[Prototype]] internal slot whose value is the intrinsic
        object <emu-xref href="#sec-properties-of-the-object-prototype-object"><a href="https://tc39.github.io/ecma262/#sec-properties-of-the-object-prototype-object">%ObjectPrototype%</a></emu-xref>.
      
      </li>
      <li>is an ordinary object.</li>
      <li>does not have a [[Target]] internal slot.</li>
    </ul>

    <emu-clause id="sec-finalization-group.prototype.constructor">
      <h1><span class="secnum">2.3.1</span>FinalizationGroup.prototype.constructor</h1>
      <p>The initial value of
      <code>FinalizationGroup.prototype.constructor</code> is the intrinsic
      object <emu-xref href="#sec-finalization-group-constructor" id="_ref_10"><a href="#sec-finalization-group-constructor">%FinalizationGroup%</a></emu-xref>.</p>
    </emu-clause>

    <emu-clause id="sec-finalization-group.prototype.register">
      <h1><span class="secnum">2.3.2</span>FinalizationGroup.prototype.register ( <var>target</var> , <var>holdings</var> [, <var>unregisterToken</var> ]  )</h1>
      <p>The following steps are taken:</p>
      <emu-alg><ol><li>Let <var>finalizationGroup</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_11"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>finalizationGroup</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <emu-xref aoid="Type" id="_ref_12"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>target</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>finalizationGroup</var> does not have a [[Cells]] internal slot,
        throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>cell</var> be the <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">Record</a></emu-xref> { [[Target]] : <var>target</var>, [[Holdings]]:
        <var>holdings</var>, [[UnregisterToken]]: <var>unregisterToken</var> }.</li><li>Append <var>cell</var> to <var>finalizationGroup</var>.[[Cells]].</li><li>Return <emu-val>undefined</emu-val>.
      </li></ol></emu-alg>
    </emu-clause>

    <emu-clause id="sec-finalization-group.prototype.unregister">
      <h1><span class="secnum">2.3.3</span>FinalizationGroup.prototype.unregister ( <var>unregisterToken</var> )</h1>
      <p>The following steps are taken:</p>
      <emu-alg><ol><li>Let <var>finalizationGroup</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_13"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>finalizationGroup</var>) is not Object, throw a
        <emu-val>TypeError</emu-val> exception.</li><li>If <var>finalizationGroup</var> does not have a [[Cells]]
        internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>removed</var> be <emu-val>false</emu-val>.</li><li>For each <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">Record</a></emu-xref> { [[Target]], [[Holdings]],
        [[UnregisterToken]] } <var>cell</var> that is an element of
        <var>finalizationGroup</var>.[[Cells]], do<ol><li>If <emu-xref aoid="SameValue" id="_ref_14"><a href="https://tc39.github.io/ecma262/#sec-samevalue">SameValue</a></emu-xref>(<var>cell</var>.[[UnregisterToken]], <var>unregisterToken</var>) is <emu-val>true</emu-val>, then<ol><li>Remove <var>cell</var> from <var>finalizationGroup</var>.[[Cells]].</li><li>Set <var>removed</var> to <emu-val>true</emu-val>.</li></ol></li></ol></li><li>Return <var>removed</var>.
      </li></ol></emu-alg>
    </emu-clause>

    <emu-clause id="sec-finalization-group.prototype.cleanupSome">
      <h1><span class="secnum">2.3.4</span>FinalizationGroup.prototype.cleanupSome ( [ <var>callback</var> ] )</h1>
      <p>The following steps are taken:</p>
      <emu-alg><ol><li>Let <var>finalizationGroup</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_15"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>finalizationGroup</var>) is not Object, throw a
        <emu-val>TypeError</emu-val> exception.</li><li>If <var>finalizationGroup</var> does not have a [[Cells]]
        internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Perform !&nbsp;<emu-xref aoid="FinalizationGroupCleanupJob" id="_ref_16"><a href="#sec-finalization-group-cleanup-job">FinalizationGroupCleanupJob</a></emu-xref>(<var>finalizationGroup</var>, <var>callback</var>).</li><li>Return <emu-val>undefined</emu-val>.
      </li></ol></emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-finalization-group-instances">
    <h1><span class="secnum">2.4</span>Properties of FinalizationGroup Instances</h1>
    <p>
      FinalizationGroup instances are ordinary objects that inherit
      properties from the FinalizationGroup
      prototype. FinalizationGroup instances also have [[Cells]]
      and [[CleanupCallback]] internal slot.
    
    </p>
  </emu-clause>

  <emu-clause id="sec-finalization-group-cleanup-iterator-objects">
   <h1><span class="secnum">2.5</span>FinalizationGroup Cleanup Iterator Objects</h1>
    <p>
      A FinalizationGroup Cleanup Iterator is an ordinary object, with
      the structure defined below, that represents a specific iteration
      over some specific FinalizationGroup instance object. There is not
      a named constructor for FinalizationGroup Cleanup Iterator
      objects. Instead, these iterator objects are created when the
      cleanupCallback of the FinalizationGroup is called.
    
    </p>

    <emu-clause id="sec-createfinalizationgroupcleanupiterator" aoid="CreateFinalizationGroupCleanupIterator">
      <h1><span class="secnum">2.5.1</span>CreateFinalizationGroupCleanupIterator ( <var>finalizationGroup</var> )</h1>
      <p>The following steps are taken:</p>
      <emu-alg><ol><li>Let <var>finalizationGroup</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_17"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>finalizationGroup</var>) is not Object, throw a
        <emu-val>TypeError</emu-val> exception.</li><li>If <var>finalizationGroup</var> does not have a [[Cells]]
        internal slot, throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>iterator</var> be <emu-xref aoid="ObjectCreate" id="_ref_18"><a href="https://tc39.github.io/ecma262/#sec-objectcreate">ObjectCreate</a></emu-xref>(%FinalizationGroupCleanupIteratorPrototype%, « [[FinalizationGroup]] »).</li><li>Set <var>iterator</var>.[[FinalizationGroup]] to <var>finalizationGroup</var>.</li><li>Return <var>iterator</var>.
      </li></ol></emu-alg>
    </emu-clause>

     <emu-clause id="sec-%finalizationgroupcleanupiterator%-object">
      <h1><span class="secnum">2.5.2</span>The %FinalizationGroupCleanupIteratorPrototype% Object</h1>
      <p>The  <dfn>%FinalizationGroupCleanupIteratorPrototyp%</dfn> object:</p>
      <ul>
        <li>has properties that are inherited by all FinalizationGroup
          Cleanup Iterator Objects.</li>
        <li>is an ordinary object.</li>
        <li>has a [[Prototype]] internal slot whose value is the intrinsic object <emu-xref href="#sec-%iteratorprototype%-object"><a href="https://tc39.github.io/ecma262/#sec-%iteratorprototype%-object">%IteratorPrototype%</a></emu-xref>.</li>
        <li>has the following properties:</li>
      </ul>

      <emu-clause id="sec-%finalizationgroupcleanupiterator%.next">
          <h1><span class="secnum">2.5.2.1</span>%FinalizationGroupCleanupIteratorPrototype%.next ( )</h1>
          <emu-alg><ol><li>Let <var>iterator</var> be the <emu-val>this</emu-val> value.</li><li>If <emu-xref aoid="Type" id="_ref_19"><a href="https://tc39.github.io/ecma262/#sec-ecmascript-data-types-and-values">Type</a></emu-xref>(<var>iterator</var>) is not Object, throw a <emu-val>TypeError</emu-val> exception.</li><li>If <var>iterator</var> does not have a [[FinalizationGroup]] internal slot,
            throw a <emu-val>TypeError</emu-val> exception.</li><li>Let <var>finalizationGroup</var> be <var>iterator</var>.[[FinalizationGroup]].</li><li>If <var>finalizationGroup</var> is <emu-val>undefined</emu-val>, then<ol><li>Return <emu-xref aoid="CreateIterResultObject" id="_ref_20"><a href="https://tc39.github.io/ecma262/#sec-createiterresultobject">CreateIterResultObject</a></emu-xref>(<emu-val>undefined</emu-val>, <emu-val>true</emu-val>).</li></ol></li><li>Assert: <var>finalizationGroup</var> has [[Cells]] internal slot.</li><li>If <var>finalizationGroup</var>.[[Cells]] contains a <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">Record</a></emu-xref> <var>cell</var> such that <var>cell</var>.[[Target]] is <emu-const>empty</emu-const>,<ol><li>Choose any such <var>cell</var>.</li><li>Remove <var>cell</var> from <var>finalizationGroup</var>.[[Cells]].</li><li>Return <emu-xref aoid="CreateIterResultObject" id="_ref_21"><a href="https://tc39.github.io/ecma262/#sec-createiterresultobject">CreateIterResultObject</a></emu-xref>(<var>cell</var>.[[Holdings]], <emu-val>false</emu-val>).</li></ol></li><li>Otherwise, return <emu-xref aoid="CreateIterResultObject" id="_ref_22"><a href="https://tc39.github.io/ecma262/#sec-createiterresultobject">CreateIterResultObject</a></emu-xref>((<emu-val>undefined</emu-val>, <emu-val>true</emu-val>).
          </li></ol></emu-alg>
     </emu-clause>

      <emu-clause id="sec-%finalizationgroupcleanupiteratorprototype%-@@tostringtag">
        <h1><span class="secnum">2.5.2.2</span>%FinalizationGroupCleanupIteratorPrototype% [ @@toStringTag ]</h1>
        <p>The initial value of the @@toStringTag property is the String value <code>"FinalizationGroup Cleanup Iterator"</code>.</p>
        <p>This property has the attributes { [[Writable]]: <emu-val>false</emu-val>, [[Enumerable]]: <emu-val>false</emu-val>, [[Configurable]]: <emu-val>true</emu-val> }.</p>
      </emu-clause>
    </emu-clause>

    <emu-clause id="sec-properties-of-finalization-group-cleanup-iterator-instances">
      <h1><span class="secnum">2.5.3</span>Properties of FinalizationGroup Cleanup Iterator Instances</h1>
      <p>FinalizationGroup Cleanup Iterator instances are ordinary
        objects that inherit properties from the
        %FinalizationGroupCleanupIteratorPrototype% intrinsic
        object. FinalizationGroup Cleanup Iteratorinstances are
        initially created with a [[FinalizationGroup]] internal slot.
     
    

  

</p></emu-clause></emu-clause></emu-clause></emu-import>
<emu-import href="./abstract-jobs.html"><emu-clause id="sec-abstract-jobs">
  <h1><span class="secnum">3</span> Abstract Jobs  </h1>

    <emu-table id="table-agent-record" caption="Agent Record Fields"><figure><figcaption>Table 1: Agent <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">Record</a></emu-xref> Fields</figcaption>
      <table>
        <tbody>
          <tr>
            <th>Field Name</th>
            <th>Value</th>
            <th>Meaning</th>
          </tr>
          <tr>
            <td>[[LittleEndian]]</td>
            <td>Boolean</td>
            <td>The default value computed for the  <em>isLittleEndian</em> parameter when it is needed by the algorithms <emu-xref aoid="GetValueFromBuffer" id="_ref_23"><a href="https://tc39.github.io/ecma262/#sec-getvaluefrombuffer">GetValueFromBuffer</a></emu-xref> and <emu-xref aoid="SetValueInBuffer" id="_ref_24"><a href="https://tc39.github.io/ecma262/#sec-setvalueinbuffer">SetValueInBuffer</a></emu-xref>. The choice is implementation-dependent and should be the alternative that is most efficient for the implementation.  Once the value has been observed it cannot change.</td>
          </tr>
          <tr>
            <td>[[CanBlock]]</td>
            <td>Boolean</td>
            <td>Determines whether the agent can block or not.</td>
          </tr>
          <tr>
            <td>[[Signifier]]</td>
            <td>Any globally-unique value</td>
            <td>Uniquely identifies the agent within its agent cluster.</td>
          </tr>
          <tr>
            <td>[[IsLockFree1]]</td>
            <td>Boolean</td>
            <td><emu-val>true</emu-val> if atomic operations on one-byte values are lock-free, <emu-val>false</emu-val> otherwise.</td>
          </tr>
          <tr>
            <td>[[IsLockFree2]]</td>
            <td>Boolean</td>
            <td><emu-val>true</emu-val> if atomic operations on two-byte values are lock-free, <emu-val>false</emu-val> otherwise.</td>
          </tr>
          <tr>
            <td>[[CandidateExecution]]</td>
            <td>A candidate execution <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">Record</a></emu-xref></td>
            <td>See the memory model.</td>
          </tr>
          <tr>
            <td><ins>[[KeptAlive]]</ins></td>
            <td><ins><emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> of objects</ins></td>
            <td><ins>Initially a new empty <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>, representing the list of objects to be kept alive until the end of the current Job</ins></td>
          </tr>
          <tr>
            <td><ins>[[FinalizationGroups]]</ins></td>
            <td><ins><emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref> of FinalizationGroup objects</ins></td>
            <td><ins>Initially a new empty <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>, representing the set of all FinalizationGroups</ins></td>
          </tr>
        </tbody>
      </table>
    </figure></emu-table>

  <p>
    At any given time, if all references to a ECMAScript object are from a
    [[Target]] field or internal slot, and <emu-xref aoid="KeepDuringJob" id="_ref_25"><a href="#sec-keepduringjob">KeepDuringJob</a></emu-xref> was not called on the
    object during current <emu-xref aoid="RunJobs" id="_ref_26"><a href="https://tc39.github.io/ecma262/#sec-runjobs">RunJobs</a></emu-xref> algorithm/since the last microtask checkpoint,
    the implementation MAY replace the reference to the object in all such
    [[Target]] fields or internal slots with the value <emu-const>empty</emu-const>.
  
  </p>

  <emu-clause id="sec-do-agent-finalization" aoid="DoAgentFinalization">
    <h1><span class="secnum">3.1</span> DoAgentFinalization ( )</h1>
    <p> The following steps are performed:  </p>
    <emu-alg><ol><li>Let <var>agent</var> be the surrounding agent.</li><li>For each <var>finalizationGroup</var> in <var>agent</var>.[[FinalizationGroups]], do<ol><li>Let <var>hasEmptyCell</var> be !&nbsp;<emu-xref aoid="CheckForEmptyCells" id="_ref_27"><a href="#sec-check-for-empty-cells">CheckForEmptyCells</a></emu-xref>(<var>finalizationGroup</var>).</li><li>If <var>hasEmptyCell</var> is <emu-val>true</emu-val>, then<ol><li>Perfom <emu-xref aoid="EnqueueJob" id="_ref_28"><a href="https://tc39.github.io/ecma262/#sec-enqueuejob">EnqueueJob</a></emu-xref>(<code>"FinalizationJob"</code>, <emu-xref aoid="FinalizationGroupCleanupJob" id="_ref_29"><a href="#sec-finalization-group-cleanup-job">FinalizationGroupCleanupJob</a></emu-xref>, « <var>finalizationGroup</var> »).</li></ol></li></ol></li><li>Set <var>agent</var>.[[KeptAlive]] to a new empty <emu-xref href="#sec-list-and-record-specification-type"><a href="https://tc39.github.io/ecma262/#sec-list-and-record-specification-type">List</a></emu-xref>.
    </li></ol></emu-alg>
    <emu-note type="editor"><span class="note">Editor's Note</span><div class="note-contents">
      <p>In HTML, DoAgentFinalization is called between Step 2 and 3 of the  <a href="https://html.spec.whatwg.org/#perform-a-microtask-checkpoint">perform a microtask checkpoint</a> algorithm.</p>
      <p>In the ECMAScript specification, DoAgentFinalization is called as the last step of <emu-xref aoid="RunJobs" id="_ref_30"><a href="https://tc39.github.io/ecma262/#sec-runjobs">RunJobs</a></emu-xref>.</p>
      <p>A particular host environment will, in practice, only invoke DoAgentFinalization from one of these callsites. See  <a href="https://github.com/tc39/ecma262/pull/735">tc39/ecma262#735</a> for more information.</p>
    </div></emu-note>
  </emu-clause>

  <emu-clause id="sec-check-for-empty-cells" aoid="CheckForEmptyCells">
    <h1><span class="secnum">3.2</span> CheckForEmptyCells ( <var>finalizationGroup</var> )  </h1>
    <p> The following steps are performed:  </p>
    <emu-alg><ol><li>Assert: <var>finalizationGroup</var> has an [[Cells]] internal slot.</li><li>For each <var>cell</var> in <var>finalizationGroup</var>.[[Cells]], do<ol><li>If <var>cell</var>.[[Target]] is <emu-const>empty</emu-const>, then<ol><li>Return <emu-val>true</emu-val>.</li></ol></li></ol></li><li>Return <emu-val>false</emu-val>.
    </li></ol></emu-alg>
  </emu-clause>

  <emu-clause id="sec-finalization-group-cleanup-job" aoid="FinalizationGroupCleanupJob">
    <h1><span class="secnum">3.3</span> FinalizationGroupCleanupJob ( <var>finalizationGroup</var> [ , <var>callback</var> ] )  </h1>
    <p> The following steps are performed:  </p>
    <emu-alg><ol><li>Assert: <var>finalizationGroup</var> has [[Cells]] and
      [[CleanupCallback]] internal slots.</li><li>Let <var>iterator</var> be !&nbsp;<emu-xref aoid="CreateFinalizationGroupCleanupIterator" id="_ref_31"><a href="#sec-createfinalizationgroupcleanupiterator">CreateFinalizationGroupCleanupIterator</a></emu-xref>(<var>finalizationGroup</var>).</li><li>If <var>callback</var> is <emu-val>undefined</emu-val>, set <var>callback</var> to <var>finalizationGroup</var>.[[CleanupCallback]].</li><li>Perform ?&nbsp;<emu-xref aoid="Call" id="_ref_32"><a href="https://tc39.github.io/ecma262/#sec-call">Call</a></emu-xref>(<var>callback</var>, <emu-val>undefined</emu-val>, <var>iterator</var>).</li><li>Return <emu-val>undefined</emu-val>.
    </li></ol></emu-alg>
  </emu-clause>

  <emu-clause id="sec-keepduringjob" aoid="KeepDuringJob">
    <h1><span class="secnum">3.4</span>KeepDuringJob ( <var>object</var> )</h1>
    <emu-alg><ol><li>Let <var>agent</var> be the surrounding agent.</li><li>Append <var>object</var> to <var>agent</var>.[[KeptAlive]].
    </li></ol></emu-alg>
    <emu-note><span class="note">Note</span><div class="note-contents">
      When the abstract operation
      KeepDuringJob is called with a target object reference, it adds the
      target to an identity Set that will point strongly at the target until
      the end of the current Job. This may be abstractly implemented as a
      Set in the current Job that becomes unreachable when the Job ends
      because the Job becomes unreachable, or as a Set in the current Agent
      that gets cleared at the end of each Job.
    
    </div></emu-note>
  </emu-clause>
</emu-clause>
</emu-import>
</div></body>